---
title: "coral_methods_pres"
author: "LMM, EM, MV, AC, et al"
date: "14 de enero de 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

```{r packages}
#library(ggplot2)
library(tidyverse)
library(magrittr)
library(vegan)
library(cowplot)
#library(readxl)
#library(viridis)
library(trafo)
library(colorblindr)
source('r/MSEgroup.r')
source('r/BootResampler.R')
```

```{r}
if (!dir.exists('analysis/figures')){
dir.create('analysis/figures')}
```


# Field data

```{r field dataset}
reef_pts <- read.csv('data/Points_Transect_BenthicSubstrate.csv', 
                     check.names = F, stringsAsFactors = T)
#
groups <- reef_pts[,2:6]
#
available_files <- reef_pts[reef_pts$File %in%
                        list.files("data/transects"), ]

coral_spp <- read.csv('data/caribbean_spp.csv')
```

```{r coral absolute cover, warning=FALSE}
coral_cover <-   reef_pts %>% 
  select(-c(1:7)) %>% 
  select(one_of(as.character(coral_spp[coral_spp$Group.ID %in% c(1:9), "Species.name"]))) %>% 
  divide_by(375) %>% 
  multiply_by(100) %>%
  mutate(dummy = 1) %>%   #add a dummy variable
  vegdist(method = "bray")
```

```{r mse and tidy format}
raw_mse <- coral_cover %>% 
  MSEgroup.d(groups$Site) %>% 
  data.frame() %>% 
  mutate(sites = rownames(.)) %>% 
  gather(-sites, key = 'replicate', value = "MSE") %>% 
  separate(replicate, 
           into = c('value', 'replicate'), 
           sep = '[.]') %>% 
  spread(value, MSE) %>% 
  filter(replicate != 1) %>% #exclude 1st transect
  mutate(replicate = as.numeric(replicate), 
         sites =  as.factor(sites)) %>% 
  rename(mse = means) %>% 
  filter(sites != 'Petaquire' | replicate != 4) %>% 
  mutate(replicate = replace(replicate, 
                             sites == 'Petaquire' & replicate == 3, 4)
         )
```

```{r}
field_mse <- raw_mse %>% 
  filter(replicate == 4) %>% 
  left_join(groups[groups$Transect == 't3',], 
            by = c('sites' = 'Site')) %>% 
  mutate(range = upper-lower) %>% 
  mutate(prop = range/mse) %>% 
  arrange(Locality)

field_mse$sites <- factor(field_mse$sites, 
                           levels = field_mse$sites[order(field_mse$Locality)])
```


# Achieved precision

```{r}
ggplot(field_mse, aes(x = fct_rev(sites), 
                      y = mse, 
                      fill = Locality)
       ) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), 
                width= .1) +
  coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  labs(x = "Sites", y = 'Multivariate standard error') +
  scale_fill_OkabeIto() 

  #ggsave('analysis/figures/fig01.png')
```


Now we choose the set of sites for resampling

```{r}
field_mse %>% 
  arrange(desc(mse)) %>% 
  filter(range %in% head(range, 12))
```


# Transects


#Dataset construction

```{r}
NTransects <- 20
NQuadrats <- seq(5, 25, 5)
NPoints <- seq(25, 75, 25)

DF <- NULL

for(i in 1:length(NTransects)) {
  for(j in 1:length(NQuadrats)) {
    for(k in 1:length(NPoints)) {
      
      boot_DF <- BootResampler(DataFrame = available_files, 
                    nbTransects = NTransects[i], 
                    nbQuadrats = NQuadrats[j], 
                    nbPoints = NPoints[k], 
                    transects_folder = "data/transects/", 
                    SpMatrix_Path = coral_spp, 
                    randomseed = 1)
      
      group_DF <- boot_DF %>% 
        select(2:7)
      
      mse_DF <- boot_DF %>% 
        select(-c(1:7)) %>%
        select(one_of(as.character(coral_spp[coral_spp$Group.ID %in% c(1:9), "Species.name"]))) %>% 
        divide_by(375) %>% 
        multiply_by(100) %>%
        mutate(dummy = 1) %>%   #add a dummy variable
        vegdist(method = "bray") %>% 
        MSEgroup.d(group_DF$Site) %>% 
        data.frame() %>% 
        mutate(sites = rownames(.)) %>% 
        gather(-sites, key = 'replicate', 
               value = "MSE") %>% 
        separate(replicate, 
                 into = c('value', 'replicate'), 
                 sep = '[.]') %>% 
        spread(value, MSE) %>% 
        filter(replicate != 1) %>% #exclude 1st transect
        mutate(replicate = as.numeric(replicate), 
               sites =  as.factor(sites)) %>% 
        rename(mse = means) %>% 
        mutate(ntransects = NTransects[i], 
               nquads = NQuadrats[j], 
               npoints = NPoints[k])
      
      DF <- bind_rows(DF, mse_DF)
      
      print(paste("Transects: ", NTransects[i], 
                  "| Quadrats: ", NQuadrats[j], 
                  "| Points: ", NPoints[k]))
      
    }
  }
}
```

```{r}
DF <- DF %>%
  mutate(range = upper-lower) %>% 
  mutate(prop = range/mse)
```


```{r}
plot_grid(

  field_mse %>% 
  filter(Locality == 'Morrocoy') %>%
  ggplot(aes(x = sites, y = mse)) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= .1) +
  #coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  ylim(0, 0.30) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1,
                                   vjust = 0.5),
        axis.title.y = element_blank()) +
  labs(x = "Morrocoy")
,

field_mse %>% 
  filter(Locality == 'Cubagua') %>%
  ggplot(aes(x = sites, y = mse)) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= .1) +
  #coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  ylim(0, 0.30) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1,
                                   vjust = 0.5),
        axis.title.y = element_blank()) +
  labs(x = "Cubagua")
,
field_mse %>% 
  filter(Locality == 'Los Frailes') %>%
  ggplot(aes(x = sites, y = mse)) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= .1) +
  #coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  ylim(0, 0.30) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1,
                                   vjust = 0.5),
        axis.title.y = element_blank()) +
  labs(x = "Los Frailes")
,

field_mse %>% 
  filter(Locality == 'Mochima') %>%
  ggplot(aes(x = sites, y = mse)) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= .1) +
  #coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  ylim(0, 0.30) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1,
                                   vjust = 0.5),
        axis.title.y = element_blank()) +
  labs(x = "Mochima")
,
field_mse %>% 
  filter(Locality == 'Chichiriviche') %>%
  ggplot(aes(x = sites, y = mse)) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= .1) +
  #coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  ylim(0, 0.30) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1,
                                   vjust = 0.5),
        axis.title.y = element_blank()) +
  labs(x = "Chichiriviche")
,
field_mse %>% 
  filter(Locality == 'Los Roques') %>%
  ggplot(aes(x = sites, y = mse)) + 
  geom_bar(stat = 'identity') +
  geom_errorbar(aes(ymin = lower, ymax = upper), width= .1) +
  #coord_flip() +
  geom_hline(yintercept = mean(field_mse$mse),
             alpha=0.25,
             size = 2) +
  ylim(0, 0.30) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1,
                                   vjust = 0.5),
        axis.title.y = element_blank()) +
  labs(x = "Los Roques")
, align = c('hv'), nrow = 1 )
```

Now we can compare 

```{r all lines}
plot_grid(

ggplot(DF[DF$sites=='Punta Cruz',], aes(y = mse, x = replicate, color = sites)) +
  geom_point() + 
  geom_vline(xintercept = 4) #+
  #ylim(0, 0.30)
,

ggplot(raw_mse[raw_mse$sites=='Punta Cruz',], aes(y = mse, x = replicate)) +
  geom_point() + 
  geom_vline(xintercept = 4) ,#+
  #ylim(0, 0.30),

align = 'h'
)
```

```{r comparison}
set1 <- raw_mse %>% 
          select(mse, sites, replicate) %>% 
          mutate(type='field')

set2 <- DF %>% 
  select(mse, sites, replicate) %>% 
  mutate(type='boot') 
  
bind_rows(set1, set2) %>% 
  filter(sites =='Salinas') %>% 
  ggplot(aes(x = replicate, y = mse, color = type)) + 
  geom_point()
  
```



# Plots

##  Global

```{r sites as replicates}
DF %>% 
  filter(sites %in% c('Punta Cruz', 'Mero', 'Salinas')) %>% 
ggplot(aes(x = replicate, y = mse)) +
  geom_point() +
  facet_grid(nquads~npoints) +
  theme(panel.grid.major = element_line(colour='gray90'))
```


##  Particular cases

```{r Case Punta Cruz}
DF %>% 
  filter(sites %in% c('Punta Cruz')) %>% 
  rename(transects = replicate) %>% 
  mutate(npoints = as.factor(npoints), 
         nquads = as.factor(nquads)) %>% 
  ggplot(aes(x = transects, y = mse)) +
  geom_point() +
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              linetype = 2, 
              alpha = 0.1) +
  facet_grid(nquads~npoints) +
  theme(panel.grid.major = element_line(colour='gray90'))
```

```{r}
field_mse %>% 
  filter(sites %in% c('Punta Cruz')) %>% 
  rename(transects = replicate) %>% 
  ggplot(aes(x = transects, y = mse)) +
  geom_point() +
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              linetype = 2, 
              alpha = 0.1) +
  facet_grid(nquads~npoints) +
  theme(panel.grid.major = element_line(colour='gray90'))
```


# Regression

```{r regression}
mod <- lm(log(mse)~replicate*npoints*nquads, 
           data = DF[DF$sites %in% c('Mero', 'Salinas','Punta Cruz'),])

plot(mod)
```

```{r}
diagnostics(trafo_lm(mod))
summary(trafo_lm(mod))
```

## Using GAMS

```{r}
library(mgcv)
library(voxel)
```


```{r}
nl_mod <- gam(mse~s(replicate, k = 5) + 
                s(npoints, k = 3) +
                s(nquads, k = 5),
              method = 'REML',
              data = DF[DF$sites %in% c('Mero','Salinas','Punta Cruz'),])

plot(nl_mod, shade = TRUE)
summary(nl_mod)
```


```{r}
plotGAM(nl_mod, smooth.cov = 'replicate', rawOrFitted = 'raw')
```


